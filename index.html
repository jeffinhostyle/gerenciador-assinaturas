<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Gerenciador de Assinaturas</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial; padding: 20px; background: #f0f2f5; }
        .container { max-width: 1200px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; }
        button { padding: 10px 20px; margin: 5px; cursor: pointer; background: #4CAF50; color: white; border: none; border-radius: 5px; }
        input { padding: 10px; margin: 5px; border: 1px solid #ddd; border-radius: 5px; width: 200px; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { padding: 10px; text-align: left; border-bottom: 1px solid #ddd; }
        .active { background: #45a049; }
        .hidden { display: none; }
        .tab { display: inline-block; padding: 10px 20px; background: #ddd; cursor: pointer; }
        .tab.active { background: #4CAF50; color: white; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üìä Gerenciador de Assinaturas</h1>
        
        <div>
            <span class="tab active" onclick="mostrarAba('testes')">Testes</span>
            <span class="tab" onclick="mostrarAba('assinantes')">Assinantes</span>
            <span class="tab" onclick="mostrarAba('faturamento')">Faturamento</span>
        </div>

        <!-- ABA TESTES -->
        <div id="abaTestes">
            <h2>Adicionar Teste</h2>
            <input type="text" id="testeNome" placeholder="Nome">
            <input type="email" id="testeEmail" placeholder="Email">
            <button onclick="adicionarTeste()">Adicionar Teste</button>
            
            <table>
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Dias Restantes</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="listaTestes"></tbody>
            </table>
        </div>

        <!-- ABA ASSINANTES -->
        <div id="abaAssinantes" style="display:none">
            <h2>Adicionar Assinante</h2>
            <input type="text" id="assinanteNome" placeholder="Nome">
            <input type="email" id="assinanteEmail" placeholder="Email">
            <input type="number" id="assinanteValor" placeholder="Valor" step="0.01">
            <label>
                <input type="checkbox" id="vitalicio" onclick="toggleVitalicio()"> Vital√≠cio
            </label>
            <button onclick="adicionarAssinante()">Adicionar Assinante</button>
            
            <table>
                <thead>
                    <tr>
                        <th>Nome</th>
                        <th>Email</th>
                        <th>Valor</th>
                        <th>Tipo</th>
                        <th>A√ß√µes</th>
                    </tr>
                </thead>
                <tbody id="listaAssinantes"></tbody>
            </table>
        </div>

        <!-- ABA FATURAMENTO -->
        <div id="abaFaturamento" style="display:none">
            <h2>Faturamento</h2>
            <div style="background: #4CAF50; color: white; padding: 20px; border-radius: 10px; margin: 10px 0;">
                <h3>Saldo Dispon√≠vel: R$ <span id="saldo">0.00</span></h3>
                <input type="number" id="valorSaque" placeholder="Valor do saque" step="0.01">
                <button onclick="sacar()">Sacar</button>
            </div>
            
            <div style="background: #2196F3; color: white; padding: 20px; border-radius: 10px; margin: 10px 0;">
                <h3>Total Hist√≥rico: R$ <span id="total">0.00</span></h3>
            </div>
            
            <h3>√öltimas Transa√ß√µes</h3>
            <table>
                <thead>
                    <tr>
                        <th>Data</th>
                        <th>Cliente</th>
                        <th>Tipo</th>
                        <th>Valor</th>
                    </tr>
                </thead>
                <tbody id="listaTransacoes"></tbody>
            </table>
        </div>
    </div>

    <script>
        // CONFIGURA√á√ÉO SUPABASE
        const supabase = window.supabase.createClient(
            'https://jppaocfnsossquegmxjm.supabase.co',
            'sb_publishable_rImP_fInaz3rhW8SIwlzsg_xydsF4R5'
        );

        // DADOS
        let testes = [];
        let assinantes = [];
        let transacoes = [];
        let saldoAtual = 0;
        let totalHistorico = 0;

        // FUN√á√ÉO PARA MOSTRAR ABAS
        window.mostrarAba = function(aba) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');
            
            document.getElementById('abaTestes').style.display = 'none';
            document.getElementById('abaAssinantes').style.display = 'none';
            document.getElementById('abaFaturamento').style.display = 'none';
            
            if (aba === 'testes') document.getElementById('abaTestes').style.display = 'block';
            if (aba === 'assinantes') document.getElementById('abaAssinantes').style.display = 'block';
            if (aba === 'faturamento') document.getElementById('abaFaturamento').style.display = 'block';
        }

        window.toggleVitalicio = function() {
            const valor = document.getElementById('assinanteValor');
            valor.disabled = document.getElementById('vitalicio').checked;
        }

        // CARREGAR DADOS
        async function carregarDados() {
            try {
                const { data: a } = await supabase.from('assinantes').select('*');
                const { data: t } = await supabase.from('testes').select('*');
                const { data: tr } = await supabase.from('transacoes').select('*').order('data', { ascending: false });
                const { data: f } = await supabase.from('faturamento').select('*').eq('id', 1).single();
                
                if (a) assinantes = a;
                if (t) testes = t;
                if (tr) transacoes = tr;
                if (f) {
                    saldoAtual = f.saldo_atual || 0;
                    totalHistorico = f.total_historico || 0;
                }
                
                atualizarTela();
            } catch (error) {
                console.error('Erro:', error);
            }
        }

        // ATUALIZAR TELA
        function atualizarTela() {
            // Atualizar estat√≠sticas
            document.getElementById('saldo').textContent = saldoAtual.toFixed(2);
            document.getElementById('total').textContent = totalHistorico.toFixed(2);
            
            // Lista de testes
            let htmlTestes = '';
            testes.forEach(t => {
                htmlTestes += `<tr>
                    <td>${t.nome}</td>
                    <td>${t.email}</td>
                    <td>${t.dias_restantes}</td>
                    <td>
                        <button onclick="moverAssinante(${t.id})">Mover</button>
                        <button onclick="removerTeste(${t.id})">Remover</button>
                    </td>
                </tr>`;
            });
            document.getElementById('listaTestes').innerHTML = htmlTestes || '<tr><td colspan="4">Nenhum teste</td></tr>';
            
            // Lista de assinantes
            let htmlAssinantes = '';
            assinantes.forEach(a => {
                htmlAssinantes += `<tr>
                    <td>${a.nome}</td>
                    <td>${a.email}</td>
                    <td>R$ ${a.valor}</td>
                    <td>${a.tipo}</td>
                    <td><button onclick="removerAssinante(${a.id})">Remover</button></td>
                </tr>`;
            });
            document.getElementById('listaAssinantes').innerHTML = htmlAssinantes || '<tr><td colspan="5">Nenhum assinante</td></tr>';
            
            // Lista de transa√ß√µes
            let htmlTransacoes = '';
            transacoes.slice(0, 5).forEach(t => {
                htmlTransacoes += `<tr>
                    <td>${new Date(t.data).toLocaleDateString()}</td>
                    <td>${t.cliente}</td>
                    <td>${t.tipo}</td>
                    <td>R$ ${Math.abs(t.valor).toFixed(2)}</td>
                </tr>`;
            });
            document.getElementById('listaTransacoes').innerHTML = htmlTransacoes || '<tr><td colspan="4">Nenhuma transa√ß√£o</td></tr>';
        }

        // FUN√á√ïES PRINCIPAIS
        window.adicionarTeste = async function() {
            const nome = document.getElementById('testeNome').value;
            const email = document.getElementById('testeEmail').value;
            
            if (!nome || !email) {
                alert('Preencha todos os campos!');
                return;
            }
            
            await supabase.from('testes').insert([{
                nome, email,
                data_inicio: new Date(),
                dias_restantes: 15
            }]);
            
            document.getElementById('testeNome').value = '';
            document.getElementById('testeEmail').value = '';
            carregarDados();
        }

        window.adicionarAssinante = async function() {
            const nome = document.getElementById('assinanteNome').value;
            const email = document.getElementById('assinanteEmail').value;
            const valor = parseFloat(document.getElementById('assinanteValor').value) || 0;
            const vitalicio = document.getElementById('vitalicio').checked;
            
            if (!nome || !email || (!vitalicio && !valor)) {
                alert('Preencha todos os campos!');
                return;
            }
            
            await supabase.from('assinantes').insert([{
                nome, email,
                valor: vitalicio ? 0 : valor,
                tipo: vitalicio ? 'vitalicio' : 'mensal',
                data_inicio: new Date(),
                dias_restantes: vitalicio ? 9999 : 30,
                ultimo_pagamento: new Date()
            }]);
            
            if (!vitalicio) {
                await supabase.from('transacoes').insert([{
                    data: new Date(),
                    cliente: nome,
                    tipo: 'Nova Assinatura',
                    valor: valor
                }]);
                
                saldoAtual += valor;
                totalHistorico += valor;
                await supabase.from('faturamento').upsert({
                    id: 1,
                    saldo_atual: saldoAtual,
                    total_historico: totalHistorico
                });
            }
            
            document.getElementById('assinanteNome').value = '';
            document.getElementById('assinanteEmail').value = '';
            document.getElementById('assinanteValor').value = '';
            document.getElementById('vitalicio').checked = false;
            document.getElementById('assinanteValor').disabled = false;
            carregarDados();
        }

        window.moverAssinante = async function(id) {
            const teste = testes.find(t => t.id === id);
            if (!teste) return;
            
            const valor = prompt('Valor da assinatura:');
            const tipo = prompt('Tipo (mensal ou vitalicio):');
            
            if (tipo !== 'mensal' && tipo !== 'vitalicio') return;
            
            await supabase.from('assinantes').insert([{
                nome: teste.nome,
                email: teste.email,
                valor: tipo === 'vitalicio' ? 0 : parseFloat(valor),
                tipo: tipo,
                data_inicio: new Date(),
                dias_restantes: tipo === 'vitalicio' ? 9999 : 30,
                ultimo_pagamento: new Date()
            }]);
            
            await supabase.from('testes').delete().eq('id', id);
            
            if (tipo === 'mensal') {
                await supabase.from('transacoes').insert([{
                    data: new Date(),
                    cliente: teste.nome,
                    tipo: 'Convers√£o',
                    valor: parseFloat(valor)
                }]);
                
                saldoAtual += parseFloat(valor);
                totalHistorico += parseFloat(valor);
                await supabase.from('faturamento').upsert({
                    id: 1,
                    saldo_atual: saldoAtual,
                    total_historico: totalHistorico
                });
            }
            
            carregarDados();
        }

        window.removerTeste = async function(id) {
            if (confirm('Remover teste?')) {
                await supabase.from('testes').delete().eq('id', id);
                carregarDados();
            }
        }

        window.removerAssinante = async function(id) {
            if (confirm('Remover assinante?')) {
                await supabase.from('assinantes').delete().eq('id', id);
                carregarDados();
            }
        }

        window.sacar = async function() {
            const valor = parseFloat(document.getElementById('valorSaque').value);
            
            if (!valor || valor <= 0 || valor > saldoAtual) {
                alert('Valor inv√°lido!');
                return;
            }
            
            saldoAtual -= valor;
            
            await supabase.from('transacoes').insert([{
                data: new Date(),
                cliente: 'Saque',
                tipo: 'Saque',
                valor: -valor
            }]);
            
            await supabase.from('faturamento').upsert({
                id: 1,
                saldo_atual: saldoAtual,
                total_historico: totalHistorico
            });
            
            document.getElementById('valorSaque').value = '';
            carregarDados();
        }

        // INICIAR
        carregarDados();
    </script>
</body>
</html>
